services:
  # 1. THE API (Laravel 12 Standard)
  backend:
    build:
      context: ./hive-backend
      dockerfile: Dockerfile
    image: hive-backend
    container_name: hive-backend
    restart: unless-stopped
    ports:
      # ✅ Mapped 8000:8000 so the frontend browser can find it at localhost:8000
      - "8000:8000"
    environment:
      APP_ENV: local
      APP_URL: http://localhost:8000
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: hive
      DB_USERNAME: hive_user
      DB_PASSWORD: password
      # Redis Config
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Search Config
      SCOUT_DRIVER: meilisearch
      MEILISEARCH_HOST: http://meilisearch:7700
      MEILISEARCH_KEY: masterKey
      SANCTUM_STATEFUL_DOMAINS: localhost:3000
      SESSION_DOMAIN: localhost
      SESSION_SECURE_COOKIE: "false"
    volumes:
      - ./hive-backend:/var/www/html
    networks:
      - hive-network
    depends_on:
      - db
      - redis
      - meilisearch
    # ✅ Standard Laravel Server
    command: php artisan serve --host=0.0.0.0 --port=8000

  # 2. LARAVEL HORIZON (Queue Worker)
  # ✅ Runs the exact same code/image as backend, but executes the queue listener
  horizon:
    build:
      context: ./hive-backend
      dockerfile: Dockerfile
    image: hive-backend # Reuses the image built by 'backend'
    container_name: hive-horizon
    restart: unless-stopped
    environment:
      APP_ENV: local
      APP_URL: http://localhost:8000
      DB_CONNECTION: pgsql
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: hive
      DB_USERNAME: hive_user
      DB_PASSWORD: password
      # Redis Config (Critical for Horizon)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Search Config (Needed if jobs update search indexes)
      SCOUT_DRIVER: meilisearch
      MEILISEARCH_HOST: http://meilisearch:7700
      MEILISEARCH_KEY: masterKey
    volumes:
      - ./hive-backend:/var/www/html
    networks:
      - hive-network
    depends_on:
      - backend
      - db
      - redis
    # ✅ Starts the Horizon supervisor
    command: php artisan horizon

  # 3. THE FRONTEND (Next.js 16)
  frontend:
    build:
      context: ./hive-frontend
      dockerfile: Dockerfile
    image: hive-frontend
    container_name: hive-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./hive-frontend:/app
      - /app/node_modules
    networks:
      - hive-network
    environment:
      # ✅ Server-side calls talk to container 'backend'
      INTERNAL_API_URL: http://backend:8000/api
      # ✅ Client-side calls talk to localhost:8000
      NEXT_PUBLIC_API_URL: http://localhost:8000/api
      HOSTNAME: "0.0.0.0"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: npm run dev

  # 4. DATABASE (Postgres)
  db:
    image: postgres:17
    container_name: hive-db
    restart: unless-stopped
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: hive
      POSTGRES_USER: hive_user
      POSTGRES_PASSWORD: password
    volumes:
      - hive-db-data:/var/lib/postgresql/data
    networks:
      - hive-network

  # 5. CACHE & QUEUES (Redis)
  redis:
    image: redis:alpine
    container_name: hive-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - hive-network

  # 6. SEARCH ENGINE (Meilisearch)
  meilisearch:
    image: getmeili/meilisearch:v1.10
    container_name: hive-search
    restart: unless-stopped
    ports:
      - "7700:7700"
    environment:
      - MEILI_MASTER_KEY=masterKey
    volumes:
      - hive-search-data:/meili_data
    networks:
      - hive-network

  # 7. EMAIL TESTING (Mailpit)
  mailpit:
    image: axllent/mailpit
    container_name: hive-mail
    restart: unless-stopped
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - hive-network

  # 8. DATABASE MANAGER (Adminer)
  adminer:
    image: adminer
    container_name: hive-adminer
    restart: always
    ports:
      - "8090:8080"
    environment:
      ADMINER_DEFAULT_SERVER: db
    networks:
      - hive-network

networks:
  hive-network:
    driver: bridge

volumes:
  hive-db-data:
  hive-search-data: